# Overview

An overview of the various scenarios

## Overview of combinations

<table>
<thead>
<tr>
<th>Scenario</th>
<th>type of export</th>
<th>target</th>
<th>(in)direct</th>
<th>error</th>
<th>hoisting</th>
<th>`module.exports` of circular module</th>
</tr>
</thead>
<tbody>
<tr>
<td>regular</td>
<td>default</td>
<td>es5</td>
<td>direct</td>
<td>-</td>
<td>no</td>
<td>`{}`</td>
</tr>
<tr>
<td>regular es6</td>
<td>default</td>
<td>es6</td>
<td>direct</td>
<td>y<sup><a href="#user-content-fn-1-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-1-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup></td>
<td>no</td>
<td>`{ default: getterFn() }`</td>
</tr>
<tr>
<td>regular es6 var</td>
<td>default</td>
<td>es6</td>
<td>direct</td>
<td>y<sup><a href="#user-content-fn-1-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-1-2-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup></td>
<td>yes</td>
<td>`{ default: getterFn() }`</td>
</tr>
<tr>
<td>regular indirect</td>
<td>default</td>
<td>es5</td>
<td>indirect, functions</td>
<td>y<sup><a href="#user-content-fn-2-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-2-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup></td>
<td>no</td>
<td>`{ default: expectedFn() }`</td>
</tr>
<tr>
<td>regular named exports</td>
<td>named</td>
<td>es5</td>
<td>direct</td>
<td>y<sup><a href="#user-content-fn-3-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-3-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup></td>
<td>no</td>
<td>`{ [namedExportName]: getterFn() }`</td>
</tr>
<tr>
<td>named exports es6</td>
<td>named</td>
<td>es6</td>
<td>direct</td>
<td>y<sup><a href="#user-content-fn-3-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-3-2-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup></td>
<td>no</td>
<td>`{ [namedExportName]: getterFn() }`</td>
</tr>
<tr>
<td>named indirect</td>
<td>named</td>
<td>es5</td>
<td>indirect, function</td>
<td>possibly<sup><a href="#user-content-fn-4-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-4-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">4</a></sup></td>
<td>no</td>
<td>`{ [namedExportName]: getterFn() }`</td>
</tr>
<tr>
<td>class instance regular</td>
<td>default</td>
<td>es5</td>
<td>direct</td>
<td>y<sup><a href="#user-content-fn-5-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-5-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">5</a></sup></td>
<td>no</td>
<td>`{}`</td>
</tr>
<tr>
<td>class instance named</td>
<td>default</td>
<td>es5</td>
<td>direct</td>
<td>y<sup><a href="#user-content-fn-3-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-3-3-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup></td>
<td>no</td>
<td>`{ [namedExportName]: getterFn() }`</td>
</tr>
<tr>
<td>class instance indirect named</td>
<td>named</td>
<td>es5</td>
<td>indirect</td>
<td>possibly<sup><a href="#user-content-fn-4-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-4-2-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">4</a></sup></td>
<td>no</td>
<td>`{ [namedExportName]: getterFn() }`</td>
</tr>
<tr>
<td>regular chunks entryPoints</td>
<td>default</td>
<td>es5</td>
<td>direct</td>
<td>-</td>
<td>no</td>
<td>`{}`</td>
</tr>
<tr>
<td>regular chunks dynamic import</td>
<td>default</td>
<td>es5</td>
<td>direct</td>
<td>-</td>
<td>no</td>
<td>`{}`</td>
</tr>
<tr>
<td>named chunks dynamic import</td>
<td>named</td>
<td>es5</td>
<td>indirect dynamic import</td>
<td>possibly<sup><a href="#user-content-fn-4-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-4-3-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">4</a></sup></td>
<td>no</td>
<td>`{ [namedExportName]: getterFn() }`</td>
</tr>
<tr>
<td>named chunks dynamic import ESM</td>
<td>named</td>
<td>es6<sup><a href="#user-content-fn-6-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-6-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">6</a></sup></td>
<td>indirect dynamic import</td>
<td>possibly<sup><a href="#user-content-fn-4-39e27ae64b7d78fdbf3ce2275bebb171" id="user-content-fnref-4-4-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-ref="" aria-describedby="footnote-label">4</a></sup></td>
<td>no</td>
<td>`{ [namedExportName]: getterFn() }`</td>
</tr>
</tbody>
</table>

<section data-footnotes="" className="footnotes">
<h2 id="footnote-label" className="sr-only" dir="auto">Footnotes</h2>
<ol dir="auto">
<li id="user-content-fn-1-39e27ae64b7d78fdbf3ce2275bebb171">
<p dir="auto">`Uncaught ReferenceError: Cannot access '__WEBPACK_DEFAULT_EXPORT__' before initialization` <a href="#user-content-fnref-1-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 1" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji></a> <a href="#user-content-fnref-1-2-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 1-2" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji><sup>2</sup></a></p>
</li>
<li id="user-content-fn-2-39e27ae64b7d78fdbf3ce2275bebb171">
<p dir="auto">`Maximum call stack size exceeded` <a href="#user-content-fnref-2-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 2" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji></a></p>
</li>
<li id="user-content-fn-3-39e27ae64b7d78fdbf3ce2275bebb171">
<p dir="auto">`Uncaught ReferenceError: Cannot access '{{namedExportName}}' before initialization` <a href="#user-content-fnref-3-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 3" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji></a> <a href="#user-content-fnref-3-2-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 3-2" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji><sup>2</sup></a> <a href="#user-content-fnref-3-3-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 3-3" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji><sup>3</sup></a></p>
</li>
<li id="user-content-fn-4-39e27ae64b7d78fdbf3ce2275bebb171">
<p dir="auto">depends on which named export is being called, if it returns a static value, no error or issues. If it calls a module within the circ dep chain, it will lead to `Maximum call stack size exceeded` <a href="#user-content-fnref-4-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 4" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji></a> <a href="#user-content-fnref-4-2-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 4-2" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji><sup>2</sup></a> <a href="#user-content-fnref-4-3-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 4-3" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji><sup>3</sup></a> <a href="#user-content-fnref-4-4-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 4-4" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji><sup>4</sup></a></p>
</li>
<li id="user-content-fn-5-39e27ae64b7d78fdbf3ce2275bebb171">
<p dir="auto">`cannot read {{propertyName}} of undefined`. The issue here is that the class is not exported yet, due to preliminary `module.exports = {}` <a href="#user-content-fnref-5-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 5" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji></a></p>
</li>
<li id="user-content-fn-6-39e27ae64b7d78fdbf3ce2275bebb171">
<p dir="auto">also setting `output.module = true` and `experiments.outputModule = true` <a href="#user-content-fnref-6-39e27ae64b7d78fdbf3ce2275bebb171" data-footnote-backref="" aria-label="Back to reference 6" className="data-footnote-backref"><g-emoji className="g-emoji" alias="leftwards_arrow_with_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21a9.png">↩</g-emoji></a></p>
</li>
</ol>
</section>

## Legend

### `default` vs `named`

What kind of [ES Module export statement](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/export) are we using.

Default: `export default`

Named: `export myVar` or `export { foo: varFoo, bar: varBar }`

This is important because circular dependencies with `default` exports are `undefined` when reading directly and using es5. 
This can lead to unexpected behavior, but will less likely lead to app-crashing errors.

Circular dependencies with named exports use getters and when used directly, will lead to 
`Uncaught ReferenceError: Cannot access '{{namedExportName}}' before initialization` errors which can crash your app if not caught properly.

### target

Which [Webpack output target](https://webpack.js.org/configuration/target/) are we setting?

The main difference here is that with `es6` and later, `default` exports are treated as named exports, using a getter. 
This can lead to `Uncaught ReferenceError: Cannot access '__WEBPACK_DEFAULT_EXPORT__' before initialization`

### (in)direct

Are all modules processed by Webpack before reading imported values?

Important note: indirect is not the same as async. This is all about the synchronous order of execution due to importing of scripts.

The moment we access an imported value matters:

If we access a value from a circular module before that module is processed fully, it's exports will not be set yet. It will have the preliminary `module.exports = {}`.

However, if we read value(s) from a circular module until after all modules in the circ dep chain are finished, we are able to read from the `module.exports` with its default or named exports set correctly.

The finishing part is important because webpack holds a *reference* to a module's `module.exports` and that can change once processing all modules is done:

```js entry.js
// needed to ensure right order of module processing for this example
import './moduleA.js';

import { direct, indirectFn } from './moduleB.js'

// All imports have been resolved and processed
console.log({direct, indirectFn: indirectFn() })
```

```js moduleA.js
import { bStatic } from './moduleB'

const useStaticValueFromB = `${bStatic} imported from ./moduleB`;

export default useStaticValueFromB;
```

```js moduleB.js
import useImportedValue from './moduleA';

// ModuleA's `module.exports` is preliminary set: `{}` 
const direct = useImportedValue; // const direct = undefined

// We only read `useImportedValue` when this function is called in `entry.js`
const indirectFn = () => useImportedValue;

const bStatic = 'bStatic'

export {direct, indirectFn, bStatic};
```

In the above example, by the time that we call `indirectFn()` in `entry.js` all modules have been fully processed by Webpack
and have their `module.exports` set to the correct value. 

It is important to realize that `module.exports` for `moduleA.js` is different when reading it in `moduleB.js` in direct, 
vs reading it in `entry.js` after all imports have been resolved.

## Conclusion

Hopefully these pages have given you a better understanding of the way circular dependencies are handled in Webpack.

And perhaps you've also learned a couple things about the module resolution system.

Here are some **key take aways**:

### Module resolution

- Each file (module) is transformed into a module function, where webpack handles imports and exports
- This module function is called on the first time that module is requested.
- The results of the module function are cached in `__webpack_module_cache__`
- When that same module is requested subsequent times, Webpack serves the `module.exports` from the `__webpack_module_cache__`
- **While** Webpack is processing a module with a default export, it gets a preliminary `module.exports` set to an empty object (`{}`)
- When using named exports, Webpack sets a getter for each named export on the preliminary `module.exports`
  - This happens in the module function, *before* executing any module code
- When using `es6` as target, the default export is treated as named export, with a getter for `__WEBPACK_DEFAULT_EXPORT__`

### Circular Dependencies

- Circular dependencies are solved in Webpack by preliminary assigning `module.exports = {}` even before processing the module
  - This means that that when a module requests itself in a circular dependency chain it will always return at least an empty object for the `import`/`require` of itself
  - It also means that Circular dependencies do not lead to higher memory consumption or duplication of files
- When determining how a circ dep will behave, follow the below flow chart
- Other tools (`babel`, `jest`, `typescript`) in your project might handle circular dependencies differently... 

<img src="/circ-dep-flow.png" style={{width: '100vw'}} />

## Next

There's no next, but you can return to the [first page](/)
